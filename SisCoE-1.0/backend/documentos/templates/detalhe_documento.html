{% extends "base.html" %}
{% load static %}
{% block 'title' %} Detalhe do Documento {% endblock %}

{% block 'head' %}
<script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.2.11/pdfobject.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown.min.css">
{% endblock %}

{% block 'body' %}
<br>
<div class="md:items-center md:justify-between rounded-lg mt-4 w-full " id="cad_efetivo">
    <fieldset class="p-4 mb-8 rounded-md w-full" id="second-fieldset">
        <fieldset class="p-2 mb-4 rounded-md rounded-[5px]">
            <div class="flex flex-col h-auto rounded-[10px]">
              <div class="bg-gray-700 rounded-xl shadow-2xl w-full p-4 transition-all duration-300 animate-fade-in">
                <div class="flex flex-col md:flex-row">
                  <div class="md:w-1/3 text-center mb-8 md:mb-0">
                    <div class="rounded-full w-60 h-60 mx-auto mb-4 border-4 border-indigo-800 transition-transform duration-300 hover:scale-105 flex items-center justify-center">
                        {% with imagem=arquivos|first %}
                            {% if imagem.tipo == 'IMAGEM' %}
                                <img id="profileImage" src="{{ imagem.arquivo.url }}" alt="{{ documento.assunto }}" class="rounded-full w-full h-full object-cover">
                            {% else %}
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-32 w-32 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L4 8m4-4v12" />
                                </svg>
                            {% endif %}
                        {% endwith %}
                    </div>
                    <p class="text-gray-300">{{ documento.tipo }}</p><br>
                    <button id="abrirModalEditar" class="text-white bg-cyan-600 hover:bg-cyan-700 focus:ring-4 focus:ring-cyan-200 font-medium rounded-lg text-sm inline-flex items-center px-3 py-2 text-center">Editar Documento</button>
                    <div id="modalEditar" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
                        <div class="bg-gray-600 rounded-lg shadow-lg w-full max-w-2xl">
                            <div class="flex items-start justify-between p-4 bg-gray-800 rounded-t border-gray-500">
                                <h5 class="text-xl font-semibold text-gray-300">Editar Documento</h5>
                                <button type="button" class="text-gray-200 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" data-modal-close="#modalEditar">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                                </div>
                            <div class="p-6 space-y-6">
                                <form method="post" enctype="multipart/form-data" action="{% url 'documentos:editar_documento' documento.pk %}">
                                    {% csrf_token %}
                                    <div class="mb-4">
                                        <label for="data_publicacao" class="block text-sm font-medium text-gray-400">Data de Publicação</label>
                                        <input type="date" name="data_publicacao" id="data_publicacao" value="{{ documento.data_publicacao|date:'Y-m-d' }}" class="bg-gray-700 border border-gray-600 text-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                    </div>
                                    <div class="mb-4">
                                        <label for="data_documento" class="block text-sm font-medium text-gray-400">Data do Documento</label>
                                        <input type="date" name="data_documento" id="data_documento" value="{{ documento.data_documento|date:'Y-m-d' }}" class="bg-gray-700 border border-gray-600 text-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                    </div>
                                    <div class="mb-4">
                                        <label for="numero_documento" class="block text-sm font-medium text-gray-400">Número do Documento</label>
                                        <input type="text" name="numero_documento" id="numero_documento" value="{{ documento.numero_documento }}" class="bg-gray-700 border border-gray-600 text-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                    </div>
                                    <div class="mb-4">
                                        <label for="assunto" class="block text-sm font-medium text-gray-400">Assunto</label>
                                        <input type="text" name="assunto" id="assunto" value="{{ documento.assunto }}" class="bg-gray-700 border border-gray-600 text-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                    </div>
                                    <div class="mb-4">
                                        <label for="descricao" class="block text-sm font-medium text-gray-400">Descrição</label>
                                        <textarea name="descricao" id="descricao" class="bg-gray-700 border border-gray-600 text-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">{{ documento.descricao }}</textarea>
                                    </div>
                                    <div class="mb-4">
                                        <label for="assinada_por" class="block text-sm font-medium text-gray-400">Assinada por</label>
                                        <input type="text" name="assinada_por" id="assinada_por" value="{{ documento.assinada_por }}" class="bg-gray-700 border border-gray-600 text-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                    </div>
                                    <div class="mb-4">
                                        <label for="novos_arquivos" class="block text-sm font-medium text-gray-400">Adicionar novos arquivos:</label>
                                        <input type="file" name="novos_arquivos" id="novos_arquivos" multiple class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium text-gray-700">Arquivos existentes:</label>
                                        {% for arquivo in documento.arquivos.all %}
                                            <div class="flex items-center mb-2">
                                                <a href="{{ arquivo.arquivo.url }}" target="_blank" class="text-blue-500 mr-2">
                                                    {{ arquivo.arquivo.name }}
                                                </a>
                                                <form method="post" action="{% url 'documentos:remover_arquivo' arquivo.pk %}">
                                                    {% csrf_token %}
                                                    <button type="submit" class="text-red-500 text-sm">Remover</button>
                                                </form>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <div class="mb-4">
                                        <label for="novos_arquivos" class="block text-sm font-medium text-gray-700">Adicionar novos arquivos:</label>
                                        <input type="file" name="novos_arquivos" id="novos_arquivos" multiple>
                                    </div>
                                    <div class="mb-4">
                                        <label for="tipo" class="block text-sm font-medium text-gray-400">Tipo</label>
                                        <select name="tipo" id="tipo" class="bg-gray-700 border border-gray-600 text-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                            {% for tipo, tipo_label in documento.TIPO_CHOICES %}
                                            <option value="{{ tipo }}" {% if documento.tipo == tipo %}selected{% endif %}>{{ tipo_label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="flex items-center justify-end space-x-4">
                                        <button type="button" class="text-white bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-blue-300 dark:focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center me-2 mb-2" data-modal-close="#modalEditar">Cancelar</button>
                                        <button type="submit" class="text-white bg-gradient-to-r from-green-400 via-green-500 to-green-600 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-green-300 dark:focus:ring-green-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center me-2 mb-2">Salvar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', () => {
                            const abrirModalButton = document.getElementById('abrirModalEditar');
                            const modal = document.getElementById('modalEditar');
                            const closeModalButton = modal.querySelector('[data-modal-close]');
                            abrirModalButton.addEventListener('click', () => {
                                modal.classList.remove('hidden');
                            });
                            closeModalButton.addEventListener('click', () => {
                                modal.classList.add('hidden');
                            });
                        });
                        
                    </script>
                  </div>
                  <div class="md:w-2/3 md:pl-8">
                    <h1 class="text-3xl font-semibold text-gray-300 mb-4">{{ documento.numero_documento  }}</h1>
                    <h2 class="text-2xl font-medium text-gray-300 mb-4"> Assunto:  {{ documento.assunto}}</h2>
                    <h4 class="text-1xl text-gray-500 mb-4"><b>Data do Documento:</b> <span>{{ documento.data_documento }}</span></h4>
                    <br>
                    <h2 class="text-xl font-semibold text-gray-300 mb-4"></h2>
                    <div class="flex flex-wrap gap-2 mb-6">
                    </div>
                    <h2 class="text-xl font-semibold text-gray-300 mb-4">Informações do Documento</h2>
                    <ul class="space-y-2 text-gray-500">
                      <li class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-indigo-800" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                          <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                        </svg>
                        Assinatura: {{ documento.assinada_por }}
                      </li>
                      <li class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-indigo-800" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
                        </svg>
                        Data do Documento: {{ documento.data_publicacao|date:"d/m/Y H:i:s" }}
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
        </fieldset>
        <fieldset class="mb-8 rounded-xl shadow-2xl bg-gray-200">
            <div class="p-4">
                <h2 class="mb-4 text-xl font-semibold text-indigo-800">Arquivos Anexados</h2>
                <hr class="my-4 border-b border-gray-500">
                
                <div class="space-y-6">
                    {% for arquivo in arquivos %} 
                     <div class="p-4 bg-gray-100 rounded-lg shadow">

                        
                        {% if arquivo.tipo == 'IMAGEM' %}
                        <div class="mb-4">
                            <img src="{{ arquivo.arquivo.url }}" 
                                alt="{{ documento.assunto }}" 
                                class="h-auto max-w-full rounded-lg shadow-lg cursor-pointer"
                                onclick="openLightbox('{{ arquivo.arquivo.url }}')">
                        </div>

                        {% elif arquivo.tipo == 'VIDEO' %}
                        <div class="relative mx-auto max-w-[640px] max-h-[360px] bg-gray-800 rounded-lg overflow-hidden shadow-lg">
                            <video controls class="w-full h-full aspect-video">
                                {% if arquivo.extension == 'mp4' %}
                                <source src="{{ arquivo.arquivo.url }}" type="video/mp4">
                                {% elif arquivo.extension == 'webm' %}
                                <source src="{{ arquivo.arquivo.url }}" type="video/webm">
                                {% else %}
                                <source src="{{ arquivo.arquivo.url }}" type="video/{{ arquivo.extension }}">
                                {% endif %}
                                Seu navegador não suporta vídeos HTML5.
                            </video>
                        </div>

                        {% elif arquivo.tipo == 'AUDIO' %}
                        <div class="p-4 bg-white rounded-lg">
                            <audio controls class="w-full">
                                <source src="{{ arquivo.arquivo.url }}" 
                                        type="audio/{{ arquivo.extension }}">
                                Seu navegador não suporta áudio HTML5.
                            </audio>
                        </div>

                        {% elif arquivo.tipo == 'PDF' %}
                        <div class="p-2 bg-white rounded-lg shadow">
                            <div class="flex flex-wrap gap-2 mb-2">
                                <button class="px-3 py-1 bg-gray-200 rounded zoom-in">+</button>
                                <button class="px-3 py-1 bg-gray-200 rounded zoom-out">-</button>
                                <button class="px-3 py-1 bg-gray-200 rounded prev-page">Anterior</button>
                                <span class="mx-2 self-center">
                                    Página <span class="current-page">1</span> de 
                                    <span class="total-pages">...</span>
                                </span>
                                <button class="px-3 py-1 bg-gray-200 rounded next-page">Próxima</button>
                            </div>
                            <div id="pdf-viewer-{{ forloop.counter }}" 
                                 class="h-[600px] overflow-auto relative"
                                 data-url="{{ arquivo.arquivo.url }}">
                            </div>
                            <div class="mt-2">
                                <a href="{{ arquivo.arquivo.url }}" 
                                   download 
                                   class="text-blue-600 hover:underline">
                                   Download PDF
                                </a>
                            </div>
                        </div>
                        
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                const pdfContainers = document.querySelectorAll('.pdf-viewer');
                                
                                pdfContainers.forEach(container => {
                                    const url = container.dataset.url;
                                    let scale = 1.5;
                                    let currentPage = 1;
                                    let pdfInstance = null;
                                    let containerId = container.id;
                            
                                    // Inicialização do PDF
                                    pdfjsLib.getDocument(url).promise.then(pdf => {
                                        pdfInstance = pdf;
                                        const totalPages = pdf.numPages;
                                        container.parentElement.querySelector('.total-pages').textContent = totalPages;
                            
                                        // Renderizar página inicial
                                        renderPage();
                            
                                        // Controles de navegação
                                        container.closest('.pdf-viewer-container').querySelector('.prev-page').addEventListener('click', () => {
                                            if(currentPage > 1) {
                                                currentPage--;
                                                renderPage();
                                                updatePageNumber();
                                            }
                                        });
                            
                                        container.closest('.pdf-viewer-container').querySelector('.next-page').addEventListener('click', () => {
                                            if(currentPage < totalPages) {
                                                currentPage++;
                                                renderPage();
                                                updatePageNumber();
                                            }
                                        });
                            
                                        // Controles de zoom
                                        container.closest('.pdf-viewer-container').querySelector('.zoom-in').addEventListener('click', () => {
                                            scale += 0.25;
                                            renderPage();
                                        });
                            
                                        container.closest('.pdf-viewer-container').querySelector('.zoom-out').addEventListener('click', () => {
                                            scale = Math.max(0.5, scale - 0.25);
                                            renderPage();
                                        });
                                    });
                            
                                    function renderPage() {
                                        pdfInstance.getPage(currentPage).then(page => {
                                            const viewport = page.getViewport({ scale: scale });
                                            const canvas = document.createElement('canvas');
                                            const context = canvas.getContext('2d');
                                            
                                            canvas.height = viewport.height;
                                            canvas.width = viewport.width;
                                            
                                            container.innerHTML = '';
                                            container.appendChild(canvas);
                            
                                            const renderContext = {
                                                canvasContext: context,
                                                viewport: viewport
                                            };
                                            
                                            page.render(renderContext);
                                        });
                                    }
                            
                                    function updatePageNumber() {
                                        container.parentElement.querySelector('.current-page').textContent = currentPage;
                                    }
                                });
                            });
                            </script>

                        {% elif arquivo.tipo == 'TEXT' %}
                        <div class="p-4 overflow-auto bg-white border border-gray-300 rounded-lg max-h-[500px]">
                            <pre class="font-mono whitespace-pre-wrap">{{ arquivo.conteudo }}</pre>  </div>

                        {% elif arquivo.tipo == 'VIDEO' %}
                    <div class="relative overflow-hidden bg-black rounded-lg aspect-video">
                        <video controls class="w-full h-full">
                            {% if arquivo.extension == 'mp4' %}
                            <source src="{{ arquivo.arquivo.url }}" type="video/mp4">
                            {% elif arquivo.extension == 'webm' %}
                            <source src="{{ arquivo.arquivo.url }}" type="video/webm">
                            {% else %}
                            <source src="{{ arquivo.arquivo.url }}" type="video/{{ arquivo.extension }}">
                            {% endif %}
                        </video>
                    </div>

                    {% elif arquivo.tipo == 'AUDIO' %}
                    <div class="p-4 bg-white rounded-lg">
                        <audio controls class="w-full">
                            {% if arquivo.extension == 'mp3' %}
                            <source src="{{ arquivo.arquivo.url }}" type="audio/mpeg">
                            {% elif arquivo.extension == 'wav' %}
                            <source src="{{ arquivo.arquivo.url }}" type="audio/wav">
                            {% else %}
                            <source src="{{ arquivo.arquivo.url }}" type="audio/{{ arquivo.extension }}">
                            {% endif %}
                        </audio>
                    </div>
                    

                    {% elif arquivo.tipo == 'SHEET' %}
                    <div class="p-4 bg-white rounded-lg shadow">
                        <div id="sheet-container-{{ forloop.counter }}" class="overflow-auto max-h-[500px]"></div>
                        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
                        <script>
                            (async () => {
                                const response = await fetch("{{ arquivo.arquivo.url }}");
                                const data = await response.arrayBuffer();
                                const workbook = XLSX.read(data, {type: 'array'});
                                const html = XLSX.utils.sheet_to_html(workbook.Sheets[workbook.SheetNames[0]]);
                                document.getElementById('sheet-container-{{ forloop.counter }}').innerHTML = html;
                            })();
                        </script>
                    </div>
                    
                        {% else %}
                        <div>
                            <a href="{{ arquivo.arquivo.url }}" 
                            download 
                            class="text-blue-600 hover:underline">
                            Download do Arquivo ({{ arquivo.extension|upper }})
                            </a>
                        </div>
                        {% endif %}

                        <div class="mt-4 text-sm text-gray-600">
                            <p>Nome: {{ arquivo.arquivo.name }}</p>
                            <p>Tipo: {{ arquivo.get_tipo_display }}</p>
                            <p>Tamanho: {{ arquivo.arquivo.size|filesizeformat }}</p>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-gray-700">Nenhum arquivo anexado.</p>
                    {% endfor %}
                </div>
            </div>
        </fieldset>

        <fieldset class="bg-gray-200 mb-8 rounded-xl shadow-2xl">
            <div class="">
                <div class="bg-gray-200 rounded-xl p-8">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">     <p class="text-gray-700"><strong>Assunto:  </strong> {{ documento.assunto}}</p>
                    </h2>
                    <hr class="my-4 border-b-1 border-gray-500">
                    <div class="space-y-4">
                        
                        <div class="space-y-4">
                            {% if documento.tipo == 'DOC' %}
                            <div class="border p-4 rounded-md">
                                {{ conteudo }}
                            </div>
                            {% else %}
                            <div class="mb-4 prose max-w-none">
                                {{ descricao_html|safe }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>
         <fieldset class="p-4 mb-8 rounded-md w-full" id="second-fieldset">
        <fieldset class="bg-gray-100 p-2 mb-2 rounded-md">
          <div id="01" class="flex flex-wrap">
            <div class="w-full bg-lightblue p-4 rounded-md">
              <div class="flex flex-wrap">
                <div class="w-full md:w-1/2">
                  <div class="container1">
                    <div class="flex justify-start">
                      <button id="abrirModalExcluir" class="text-white bg-gradient-to-r from-red-400 via-red-500 to-red-600 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-red-300 dark:focus:ring-red-800 shadow-lg shadow-red-500/50 dark:shadow-lg dark:shadow-red-800/80 font-medium rounded-lg text-sm px-5 py-2.5 text-center me-2 mb-2">Excluir</button>
                    </div>
                  </div>
                </div>         
                <div class="w-full md:w-1/2 text-right rounded-md">
                  <div class="container1">
                    <div class="flex justify-end">
                      <a href="{% url 'documentos:listar_documentos' %}" class="text-white bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-blue-300 dark:focus:ring-blue-800 shadow-lg shadow-blue-500/50 dark:shadow-lg dark:shadow-blue-800/80 font-medium rounded-lg text-sm px-5 py-2.5 text-center me-2 mb-2">Voltar</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </fieldset>
    </fieldset>
</div>

<div id="modalExcluir" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-gray-600 rounded-lg shadow-lg p-6">
        <p class="text-lg text-gray-300 mb-4">Tem certeza de que deseja excluir este documento?</p>
        <div class="flex justify-end space-x-4">
            <button id="cancelarExclusao" class="text-gray-300 bg-gray-700 hover:bg-gray-800 rounded-lg px-4 py-2">Cancelar</button>
            <a href="{% url 'documentos:excluir_documento' documento.pk %}" class="text-white bg-red-600 hover:bg-red-700 rounded-lg px-4 py-2">Excluir</a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const abrirModalButton = document.getElementById('abrirModalExcluir');
        const modal = document.getElementById('modalExcluir');
        const cancelarExclusaoButton = document.getElementById('cancelarExclusao');

        abrirModalButton.addEventListener('click', () => {
            modal.classList.remove('hidden');
        });

        cancelarExclusaoButton.addEventListener('click', () => {
            modal.classList.add('hidden');
        });
    });
</script>

<script>
    function updateBorderColor() {
        // Seu código de atualização de cor da borda aqui
    }
    updateBorderColor();
    window.addEventListener('online', updateBorderColor);
    window.addEventListener('offline', updateBorderColor);
</script>
{% endblock %}